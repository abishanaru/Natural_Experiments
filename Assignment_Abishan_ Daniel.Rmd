---
title: "Natural Experiments"
author: "Abishan Arumugavel and Daniel Beeler"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Title 1

## Importing Data
Here we import the relevant dataset into our project.
```{r}
library(readr)
data <- read.csv("results.csv")
premier_league_2024 = read.csv("premier league.csv")
library(readxl)
attendance <- read_excel("Attendance.xlsx")

```

## Data Cleaning
Here we clean the data, and add relevant columns, which we need for our further analysis.
```{r}
# Calculate goal difference
data$goal_difference <- data$home_goals - data$away_goals

# Calculate points for the home team (3 points for win, 1 point for a draw, 0 points for a loss)
data$points_home <- ifelse(data$result == "H", 3, ifelse(data$result == "D", 1, 0))

# Calculate points for the away team (3 points for win, 1 point for a draw, 0 points for a loss)
data$points_away <- ifelse(data$result == "A", 3, ifelse(data$result == "D", 1, 0))

library(dplyr)

attendance <- attendance %>%
  rename(
    season = Saison,
    team = Team,
    average_attendance = `Average Attendance`
  )

data <- data %>%
  left_join(attendance, 
            by = c("season" = "season", 
                   "home_team" = "team")) %>%
  rename(home_average_attendance = average_attendance)

```


## Analysis
### Abishan
We have decided to conduct an analysis on the Premier League data for the 2024 season. We will be looking at the performance of a specific team and their opponents in terms of win and loss streaks. This analysis will help us understand the momentum of the teams and how it might affect the outcome of future matches. We will also investigate the impact of the venue (home or away) on the team's performance.

Here for we used the data set only from the season 2024, because this was the only dataset we found with the necessary information.
```{r}
# Sort the data by date
premier_league <- premier_league_2024[order(premier_league_2024$Date),]

str(premier_league)

```

### Interpretation
The model starts at a baseline win probability of 0.299387 when the team is playing away (is_home = 0), with no win or lose streaks. The coefficients for the is_home variable, win_streak, and lose_streak represent the change in win probability associated with each unit increase in the respective variable, holding other variables constant.

```{r}
# Load required libraries
library(dplyr)
library(tidyr)
library(stats)
library(ggplot2)
library(gridExtra)

# Create team results dataframe
team_results <- premier_league %>%
  select(Date, Team, Opponent, Result, Venue) %>%
  mutate(Date = as.Date(Date))

# Create opponent results dataframe with flipped outcomes
opponent_results <- premier_league %>%
  select(Date, Team, Opponent, Result, Venue) %>%
  mutate(
    Result = case_when(
      Result == "W" ~ "L",
      Result == "L" ~ "W",
      Result == "D" ~ "D"
    ),
    temp = Team,
    Team = Opponent,
    Opponent = temp,
    Venue = ifelse(Venue == "Home", "Away", "Home"),
    Date = as.Date(Date)
  ) %>%
  select(-temp)

# Combine and calculate streaks
all_results <- rbind(team_results, opponent_results) %>%
  arrange(Date, Team) %>%
  group_by(Team) %>%
  arrange(Date) %>%
  mutate(
    win_streak = cumsum(Result == "W") - cumsum(Result != "W" & lag(Result == "W", default = FALSE)),
    lose_streak = cumsum(Result == "L") - cumsum(Result != "L" & lag(Result == "L", default = FALSE))
  ) %>%
  ungroup()

# Prepare modeling data
model_data <- all_results %>%
  mutate(
    win = ifelse(Result == "W", 1, 0),
    is_home = ifelse(Venue == "Home", 1, 0)
  ) %>%
  select(win, is_home, win_streak, lose_streak)

# Fit linear regression model
model <- lm(win ~ is_home + win_streak + lose_streak, data = model_data)
correlation_matrix <- cor(model_data)

# Create visualization plots
venue_plot <- ggplot(model_data, aes(x = factor(is_home), y = win)) +
  geom_bar(stat = "summary", fun = "mean", fill = "skyblue") +
  geom_errorbar(stat = "summary", fun.data = "mean_se", width = 0.2) +
  scale_x_discrete(labels = c("Away", "Home")) +
  labs(x = "Venue", y = "Win Probability", title = "Win Probability by Venue") +
  theme_minimal()

win_streak_plot <- ggplot(model_data, aes(x = win_streak, y = win)) +
  geom_smooth(method = "loess", se = TRUE, color = "blue") +
  geom_jitter(alpha = 0.1, height = 0.05) +
  labs(x = "Win Streak", y = "Win Probability", title = "Win Probability by Win Streak") +
  theme_minimal()

lose_streak_plot <- ggplot(model_data, aes(x = lose_streak, y = win)) +
  geom_smooth(method = "loess", se = TRUE, color = "red") +
  geom_jitter(alpha = 0.1, height = 0.05) +
  labs(x = "Lose Streak", y = "Win Probability", title = "Win Probability by Lose Streak") +
  theme_minimal()

coef_data <- data.frame(
  variable = names(coef(model))[-1],
  coefficient = coef(model)[-1],
  se = summary(model)$coefficients[-1, "Std. Error"]
)

coef_plot <- ggplot(coef_data, aes(x = variable, y = coefficient)) +
  geom_bar(stat = "identity", fill = "lightgreen") +
  geom_errorbar(aes(ymin = coefficient - 1.96 * se, 
                    ymax = coefficient + 1.96 * se), 
                width = 0.2) +
  labs(x = "Variables", y = "Coefficient Value", 
       title = "Model Coefficients with 95% CI") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Combine and display all plots
combined_plots <- grid.arrange(
  venue_plot, win_streak_plot, 
  lose_streak_plot, coef_plot,
  ncol = 2
)

# Print results
print(summary(model))
print(correlation_matrix)
print(combined_plots)
```
Let me help analyze these results:

1. From the correlation matrix:
- Home advantage has a small positive correlation with winning (0.14)
- Win streaks have a moderate positive correlation with winning (0.28)
- Losing streaks have a negative correlation with winning (-0.19)
- There's very little correlation between streaks and home/away games
- Win and lose streaks have a small positive correlation (0.11)

2. From the linear regression model:
- All variables are highly significant (p < 2e-16)
- The coefficients show:
  * Base win probability (intercept): 0.30 or 30%
  * Home advantage adds 0.13 or 13% to win probability
  * Each additional win in a streak adds 0.019 or 1.9%
  * Each additional loss in a streak reduces chances by 0.015 or 1.5%
- The model explains about 14.5% of the variance (Adjusted R-squared: 0.1446)
- The F-statistic (86.62) with a very low p-value indicates the model is significant

3. There seem to be two models in your output:
- A linear regression (lm)
- A logistic regression (glm)
The logistic regression shows similar patterns but with different magnitudes:
- Home advantage: 0.59 log-odds (larger effect)
- Win streak: 0.13 log-odds (positive effect)
- Lose streak: -0.13 log-odds (negative effect)

4. There are some errors in the output suggesting missing data:
- An Excel file with attendance data couldn't be found
- The 'attendance' object is missing

## Logistisches Regressionsmodell

Wir haben ein logistisches Regressionsmodell geschätzt, um den Einfluss von Gewinn- und Verlustserien sowie des Spielorts (Heim/Auswärts) auf die Wahrscheinlichkeit eines Sieges zu untersuchen. Die Modellformel lautet:

$$
\log\left(\frac{p}{1-p}\right) = \beta_0 + \beta_1 \cdot \texttt{streaks\_win\_streak\_before} + \beta_2 \cdot \texttt{streaks\_lose\_streak\_before} + \beta_3 \cdot \texttt{venueHome}
$$

wobei \( p \) die Wahrscheinlichkeit eines Sieges darstellt.



### Daniel
## Analysis home advantage over all seasons

```{r}
library(dplyr)

data_summary <- data %>%
  group_by(season) %>%
  summarise(
    total_matches = n(),
    home_wins     = sum(result == "H"),
    draws         = sum(result == "D"),
    away_wins     = sum(result == "A"),
    # Calculate average home attendance (igore NA-values)
    avg_home_attendance = mean(home_average_attendance, na.rm = TRUE)
  ) %>%
  mutate(
    pct_home_wins = 100 * home_wins / total_matches,
    pct_draws     = 100 * draws / total_matches,
    pct_away_wins = 100 * away_wins / total_matches
  )

data_summary

library(dplyr)
library(tidyr)
library(ggplot2)

# 1) Keep only the relevant columns and reshape the data to long format
data_summary_long <- data_summary %>%
  select(season, pct_home_wins, pct_draws, pct_away_wins) %>%
  pivot_longer(
    cols = c(pct_home_wins, pct_draws, pct_away_wins),
    names_to = "outcome",
    values_to = "pct"
  )

# 2) Plot as a line chart
ggplot(data_summary_long, aes(x = season, y = pct, color = outcome, group = outcome)) +
  geom_line() +
  geom_point() +
  labs(
    x = "Season",
    y = "Percentage",
    color = "Outcome",
    title = "Distribution of Match Outcomes by Season"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # tilt labels if needed
  )


```
Interpretation:
We clearly see that the home team wins far more games then the away team. This counts for every season. With this analysis, we lay the basis that the home advantage is indeed correct and we can go further and try to find out, if the home advantage gets bigger, the bigger the attendance is for a game.


## Grouped analysis by attendancies
```{r}
library(dplyr)
library(ggplot2)
data %>%
  mutate(
    attendance_group = case_when(
      home_average_attendance < 25000 ~ "<25k",
      home_average_attendance < 35000 ~ "25k-35k",
      home_average_attendance < 50000 ~ "35k-50k",
      TRUE                            ~ ">50k"
    )
  ) %>%
  group_by(attendance_group) %>%
  summarise(
    total_matches = n(),
    avg_goal_diff = mean(home_goals - away_goals, na.rm = TRUE),
    pct_home_wins = mean(result == "H", na.rm = TRUE) * 100
  )


# Create 'attendance_group', reorder its levels, summarize, and store results in 'data_summary'
data_summary <- data %>%
  mutate(
    attendance_group = case_when(
      home_average_attendance < 25000 ~ "<25k",
      home_average_attendance < 35000 ~ "25k-35k",
      home_average_attendance < 50000 ~ "35k-50k",
      TRUE                            ~ ">50k"
    )
  ) %>%
  # Reorder factor levels so they appear in the desired sequence
  mutate(
    attendance_group = factor(
      attendance_group,
      levels = c("<25k", "25k-35k", "35k-50k", ">50k")
    )
  ) %>%
  # Summarize: count total matches, home wins, and compute home-win percentage
  group_by(attendance_group) %>%
  summarise(
    total_matches = n(),
    home_wins     = sum(result == "H", na.rm = TRUE),
    pct_home_wins = 100 * home_wins / total_matches
  )

# Plot a bar chart of home-win percentage by attendance group
ggplot(data_summary, aes(x = attendance_group, y = pct_home_wins)) +
  geom_col(fill = "steelblue") +
  labs(
    x = "Attendance Group",
    y = "Home Win Percentage",
    title = "Home Win Percentage by Attendance Group"
  ) +
  theme_minimal()


```
Interpretation:
We grouped the attendances for all the games into these four groupes and calculated the mean home_game_win_percentage for every group. Clearly, we see a trend, that the win percentage gets bigger, with more people in the stadium. But we have to be careful, because we have a confounder. The confounder is that the best teams (this counts for most if not every country) have the biggest stadiums (bigger fanbase etc.). Therefore its no surprise that the play in front of bigger crowds and do also win more games at home. 

## Correlation between goals/points with attendance
```{r}
# Correlation between goals with attendance
cor(data$home_goals - data$away_goals, data$home_average_attendance, use = "complete.obs")

# Correlation between points with attendance
cor(data$points_home, data$home_average_attendance, use = "complete.obs")

```
Interpretation:
We calculated a correlation between goals with attendance of 0.26 and points with attendance of 0.23. Therefore we have a small correlation between those three variables.

## look for teams whos attendance changed drastically
```{r}
library(dplyr)

df_changes <- data %>%
  # 1) Group by team
  group_by(home_team) %>%
  # 2) Sort by season within each team
  arrange(season, .by_group = TRUE) %>%
  # 3) Compute attendance difference & percentage difference
  mutate(
    attendance_diff = home_average_attendance - lag(home_average_attendance),
    attendance_diff_pct = (attendance_diff / lag(home_average_attendance)) * 100
  ) %>%
  # 4) Keep only rows with large (positive or negative) changes
  filter(!is.na(attendance_diff)) %>%  # remove the first row per team (no lag)
  filter(abs(attendance_diff_pct) > 15)

# View the teams/seasons with “drastic” changes
df_changes

```

Interpretation:
As we have a confounder, we looked through our dataset to find teams whos season home attendance changed drastically to the next season. We found 4 teams/season in which the attendance changed at least 15% (more or less). Then we did a difference-in-difference analysis, to see whether the bigger/smaller attendance could have an impact on the goal-difference of the home team.

## Difference in difference
### Tottenham Hotspurs
```{r}
library(dplyr)

data_spurs <- data %>%
  filter(season %in% c("2015-2016", "2016-2017", "2017-2018"))

data_spurs <- data_spurs %>%
  mutate(
    treat = if_else(home_team == "Tottenham Hotspur" | away_team == "Tottenham Hotspur", 1, 0),
    post  = if_else(season == "2017-2018", 1, 0)
  )

did_mod <- lm((home_goals - away_goals) ~ treat + post + treat:post, data = data_spurs)
summary(did_mod)


```

### Liverpool
```{r}
library(dplyr)

data_liv <- data %>%
  # Keep only the four relevant seasons
  filter(season %in% c("2014-2015", "2015-2016", "2016-2017", "2017-2018")) %>%
  
  # Mark Liverpool as treated (either as home team or away team if you want both),
  # but here we'll mirror the earlier approach and only mark "home_team" == "Liverpool".
  mutate(
    treat = if_else(home_team == "Liverpool", 1, 0),
    
    # post = 1 for 2016-17 and 2017-18 (the period after the attendance jump),
    # 0 for 2014-15 and 2015-16
    post = if_else(season %in% c("2016-2017", "2017-2018"), 1, 0),
    
    # Our outcome variable: goal difference from the home team's perspective
    goal_diff = home_goals - away_goals
  )

did_mod_liv <- lm(goal_diff ~ treat + post + treat:post, data = data_liv)
summary(did_mod_liv)

```

### Man City

```{r}
library(dplyr)

data_mc <- data %>%
  # Keep only the two seasons of interest
  filter(season %in% c("2014-2015", "2015-2016")) %>%
  mutate(
    treat = if_else(home_team == "Manchester City", 1, 0),
    post  = if_else(season == "2015-2016", 1, 0),
    goal_diff = home_goals - away_goals
  )

did_mod_mc <- lm(goal_diff ~ treat + post + treat:post, data = data_mc)
summary(did_mod_mc)

```


### West Ham

```{r}
library(dplyr)

data_wh <- data %>%
  # 1) Filter for the relevant seasons
  filter(season %in% c("2014-2015", "2015-2016", "2016-2017", "2017-2018")) %>%
  
  # 2) Create treat, post, and the outcome variable
  mutate(
    treat = if_else(home_team == "West Ham United", 1, 0),
    post  = if_else(season %in% c("2016-2017", "2017-2018"), 1, 0),
    goal_diff = home_goals - away_goals
  )

did_mod_wh <- lm(goal_diff ~ treat + post + treat:post, data = data_wh)
summary(did_mod_wh)

```
Interpretation of difference-in-difference:
For two teams we found a significant impact on attendance on the average goal-difference and for the other two teams we did not. Therefore its hard to say, wether we can clearly state that the bigger home crowd gets those teams an advantage or not.


## Attendancies for these 4 teams
```{r}
library(dplyr)
library(tidyr)

# Define the teams and seasons of interest
teams_of_interest <- c("Tottenham Hotspur", "Liverpool", 
                       "Manchester City", "West Ham United")
seasons_of_interest <- c("2013-2014", "2014-2015", "2015-2016", 
                         "2016-2017", "2017-2018")

# 1) Filter to the teams & seasons you want
# 2) Group by season & home_team
# 3) Summarize average attendance (ignoring NA values)
# 4) Pivot wider so each team is a separate column
# 5) Arrange by season for a nice chronological table
attendance_summary <- data %>%
  filter(home_team %in% teams_of_interest,
         season %in% seasons_of_interest) %>%
  group_by(season, home_team) %>%
  summarise(avg_home_attendance = mean(home_average_attendance, na.rm = TRUE),
            .groups = "drop") %>%
  pivot_wider(names_from = home_team, values_from = avg_home_attendance) %>%
  arrange(season)

attendance_summary

```

Interpretation:
Here I just wanted to have a table, which I can copy on the presentation, for which we see how and when the attendance changes.




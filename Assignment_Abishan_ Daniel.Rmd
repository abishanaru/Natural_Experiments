---
title: "Natural Experiments"
author: "Abishan Arumugavel and Daniel Beeler"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Title 1

## Importing Data
```{r}
library(readr)
data <- read.csv("results.csv")
library(readxl)
attendance <- read_excel("C:/DB/01 HSLU/01 Semester/Natural Experiments Using R/_PROJECT/Attendance.xlsx")

```

## Data Cleaning
```{r}
# Tordifferenz berechnen
data$goal_difference <- data$home_goals - data$away_goals

# Punkte für das Heimteam berechnen (3 für Sieg, 1 für Unentschieden, 0 für Niederlage)
data$points_home <- ifelse(data$result == "H", 3, ifelse(data$result == "D", 1, 0))

# Punkte für das Auswärtsteam berechnen (3 für Sieg, 1 für Unentschieden, 0 für Niederlage)
data$points_away <- ifelse(data$result == "A", 3, ifelse(data$result == "D", 1, 0))

library(dplyr)

attendance <- attendance %>%
  rename(
    season = Saison,
    team = Team,
    average_attendance = `Average Attendance`
  )

data <- data %>%
  left_join(attendance, 
            by = c("season" = "season", 
                   "home_team" = "team")) %>%
  rename(home_average_attendance = average_attendance)

```


## Analysis
### Abishan


### Daniel
## Analysis home advantage over all seasons

```{r}
library(dplyr)

data_summary <- data %>%
  group_by(season) %>%
  summarise(
    total_matches = n(),
    home_wins     = sum(result == "H"),
    draws         = sum(result == "D"),
    away_wins     = sum(result == "A"),
    # Durchschnittliche Home-Attendance (NA-Werte ignorieren)
    avg_home_attendance = mean(home_average_attendance, na.rm = TRUE)
  ) %>%
  mutate(
    pct_home_wins = 100 * home_wins / total_matches,
    pct_draws     = 100 * draws / total_matches,
    pct_away_wins = 100 * away_wins / total_matches
  )

data_summary

library(dplyr)
library(tidyr)
library(ggplot2)

# 1) Keep only the relevant columns and reshape the data to long format
data_summary_long <- data_summary %>%
  select(season, pct_home_wins, pct_draws, pct_away_wins) %>%
  pivot_longer(
    cols = c(pct_home_wins, pct_draws, pct_away_wins),
    names_to = "outcome",
    values_to = "pct"
  )

# 2) Plot as a line chart
ggplot(data_summary_long, aes(x = season, y = pct, color = outcome, group = outcome)) +
  geom_line() +
  geom_point() +
  labs(
    x = "Season",
    y = "Percentage",
    color = "Outcome",
    title = "Distribution of Match Outcomes by Season"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # tilt labels if needed
  )


```

## Grouped analysis by attendancies
```{r}
library(dplyr)
library(ggplot2)
data %>%
  mutate(
    attendance_group = case_when(
      home_average_attendance < 25000 ~ "<25k",
      home_average_attendance < 35000 ~ "25k-35k",
      home_average_attendance < 50000 ~ "35k-50k",
      TRUE                            ~ ">50k"
    )
  ) %>%
  group_by(attendance_group) %>%
  summarise(
    total_matches = n(),
    avg_goal_diff = mean(home_goals - away_goals, na.rm = TRUE),
    pct_home_wins = mean(result == "H", na.rm = TRUE) * 100
  )


# Create 'attendance_group', reorder its levels, summarize, and store results in 'data_summary'
data_summary <- data %>%
  mutate(
    attendance_group = case_when(
      home_average_attendance < 25000 ~ "<25k",
      home_average_attendance < 35000 ~ "25k-35k",
      home_average_attendance < 50000 ~ "35k-50k",
      TRUE                            ~ ">50k"
    )
  ) %>%
  # Reorder factor levels so they appear in the desired sequence
  mutate(
    attendance_group = factor(
      attendance_group,
      levels = c("<25k", "25k-35k", "35k-50k", ">50k")
    )
  ) %>%
  # Summarize: count total matches, home wins, and compute home-win percentage
  group_by(attendance_group) %>%
  summarise(
    total_matches = n(),
    home_wins     = sum(result == "H", na.rm = TRUE),
    pct_home_wins = 100 * home_wins / total_matches
  )

# Plot a bar chart of home-win percentage by attendance group
ggplot(data_summary, aes(x = attendance_group, y = pct_home_wins)) +
  geom_col(fill = "steelblue") +
  labs(
    x = "Attendance Group",
    y = "Home Win Percentage",
    title = "Home Win Percentage by Attendance Group"
  ) +
  theme_minimal()


```

## Correlation between goals/points with attendance
```{r}
# Correlation between goals with attendance
cor(data$home_goals - data$away_goals, data$home_average_attendance, use = "complete.obs")

# Correlation between points with attendance
cor(data$points_home, data$home_average_attendance, use = "complete.obs")

```
## look for teams whos attendance changed drastically
```{r}
library(dplyr)

df_changes <- data %>%
  # 1) Group by team
  group_by(home_team) %>%
  # 2) Sort by season within each team
  arrange(season, .by_group = TRUE) %>%
  # 3) Compute attendance difference & percentage difference
  mutate(
    attendance_diff = home_average_attendance - lag(home_average_attendance),
    attendance_diff_pct = (attendance_diff / lag(home_average_attendance)) * 100
  ) %>%
  # 4) Keep only rows with large (positive or negative) changes
  filter(!is.na(attendance_diff)) %>%  # remove the first row per team (no lag)
  filter(abs(attendance_diff_pct) > 15)

# View the teams/seasons with “drastic” changes
df_changes

```

## Difference in difference
### Tottenham Hotspurs
```{r}
library(dplyr)

data_spurs <- data %>%
  filter(season %in% c("2015-2016", "2016-2017", "2017-2018"))

data_spurs <- data_spurs %>%
  mutate(
    treat = if_else(home_team == "Tottenham Hotspur" | away_team == "Tottenham Hotspur", 1, 0),
    post  = if_else(season == "2017-2018", 1, 0)
  )

did_mod <- lm((home_goals - away_goals) ~ treat + post + treat:post, data = data_spurs)
summary(did_mod)


```

### Liverpool
```{r}
library(dplyr)

data_liv <- data %>%
  # Keep only the four relevant seasons
  filter(season %in% c("2014-2015", "2015-2016", "2016-2017", "2017-2018")) %>%
  
  # Mark Liverpool as treated (either as home team or away team if you want both),
  # but here we'll mirror the earlier approach and only mark "home_team" == "Liverpool".
  mutate(
    treat = if_else(home_team == "Liverpool", 1, 0),
    
    # post = 1 for 2016-17 and 2017-18 (the period after the attendance jump),
    # 0 for 2014-15 and 2015-16
    post = if_else(season %in% c("2016-2017", "2017-2018"), 1, 0),
    
    # Our outcome variable: goal difference from the home team's perspective
    goal_diff = home_goals - away_goals
  )

did_mod_liv <- lm(goal_diff ~ treat + post + treat:post, data = data_liv)
summary(did_mod_liv)

```
















# Ab Hier nehme ich stand jetzt nicht mit in die Präsentation
## Regression approach – Home win as a binary variable
```{r}
# Create a binary variable: Hwin = 1 for a home win, otherwise 0
data <- data %>%
  mutate(Hwin = if_else(result == "H", 1, 0))

# Logistic Modell
mod_logit <- glm(Hwin ~ home_average_attendance,
                 data = data,
                 family = binomial(link = "logit"))

summary(mod_logit)

```
## Visualization
```{r}
library(ggplot2)

ggplot(data, aes(x = home_average_attendance, 
                 y = home_goals - away_goals)) +
  geom_point(alpha = 0.3) +    # Punkte (leicht transparent)
  geom_smooth(method = "lm") + # Gerade (lineares Modell)
  labs(x = "Home Attendance", y = "Goal Difference (Home - Away)")

data %>%
  mutate(attendance_group = case_when(
    home_average_attendance < 20000 ~ "<20k",
    home_average_attendance < 40000 ~ "20k-40k",
    home_average_attendance < 60000 ~ "40k-60k",
    TRUE ~ ">60k"
  )) %>%
  ggplot(aes(x = attendance_group, y = home_goals - away_goals)) +
  geom_boxplot() +
  labs(x = "Attendance Group", y = "Goal Difference")

```



